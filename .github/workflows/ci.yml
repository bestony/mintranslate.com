name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"
          cache-on: "lockfile"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint (Biome + depcheck)
        id: lint
        continue-on-error: true
        shell: bash
        run: |
          set -o pipefail
          LINT_EXIT=0
          bun run check 2>&1 | tee lint.log
          LINT_EXIT=${PIPESTATUS[0]}
          DEP_EXIT=0
          bunx depcheck --ignores="fumadocs-mdx:collections,@types/mdx,@vitest/coverage-v8,depcheck,tailwindcss,tw-animate-css,@tanstack/router-plugin" 2>&1 | tee -a lint.log
          DEP_EXIT=${PIPESTATUS[0]}
          EXIT_CODE=0
          if [ "$LINT_EXIT" -ne 0 ] || [ "$DEP_EXIT" -ne 0 ]; then
            EXIT_CODE=1
          fi
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: Comment lint failure
        if: github.event_name == 'pull_request' && steps.lint.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = "lint.log";
            let log = fs.existsSync(path) ? fs.readFileSync(path, "utf8") : "No log file found.";
            const max = 60000;
            if (log.length > max) {
              log = `... (truncated, last ${max} chars)\n` + log.slice(-max);
            }
            const body = [
              "❌ **lint** 失败",
              "",
              "包含 `biome check` 与 `depcheck` 的输出：",
              "",
              "<details>",
              "<summary>日志</summary>",
              "",
              "```text",
              log,
              "```",
              "</details>",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail if lint failed
        if: steps.lint.outputs.exit_code != '0'
        run: exit 1

  typecheck:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"
          cache-on: "lockfile"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: TypeScript typecheck
        id: typecheck
        continue-on-error: true
        shell: bash
        run: |
          set -o pipefail
          bun x tsc -p tsconfig.json --noEmit 2>&1 | tee typecheck.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Comment typecheck failure
        if: github.event_name == 'pull_request' && steps.typecheck.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = "typecheck.log";
            let log = fs.existsSync(path) ? fs.readFileSync(path, "utf8") : "No log file found.";
            const max = 60000;
            if (log.length > max) {
              log = `... (truncated, last ${max} chars)\n` + log.slice(-max);
            }
            const body = [
              "❌ **typecheck** 失败",
              "",
              "<details>",
              "<summary>日志</summary>",
              "",
              "```text",
              log,
              "```",
              "</details>",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail if typecheck failed
        if: steps.typecheck.outputs.exit_code != '0'
        run: exit 1

  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"
          cache-on: "lockfile"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Vitest (coverage 100%)
        id: test
        continue-on-error: true
        shell: bash
        run: |
          set -o pipefail
          bun run test -- --coverage 2>&1 | tee test.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Comment test failure
        if: github.event_name == 'pull_request' && steps.test.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = "test.log";
            let log = fs.existsSync(path) ? fs.readFileSync(path, "utf8") : "No log file found.";
            const max = 60000;
            if (log.length > max) {
              log = `... (truncated, last ${max} chars)\n` + log.slice(-max);
            }
            const body = [
              "❌ **test** 失败（覆盖率要求 100%）",
              "",
              "<details>",
              "<summary>日志</summary>",
              "",
              "```text",
              log,
              "```",
              "</details>",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail if tests failed
        if: steps.test.outputs.exit_code != '0'
        run: exit 1

  e2e:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"
          cache-on: "lockfile"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Playwright e2e
        id: e2e
        continue-on-error: true
        shell: bash
        env:
          PLAYWRIGHT_HTML_OPEN: never
        run: |
          set -o pipefail
          bun run test:e2e -- --reporter=line,html 2>&1 | tee e2e.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

      - name: Comment e2e failure
        if: github.event_name == 'pull_request' && steps.e2e.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = "e2e.log";
            let log = fs.existsSync(path) ? fs.readFileSync(path, "utf8") : "No log file found.";
            const max = 60000;
            if (log.length > max) {
              log = `... (truncated, last ${max} chars)\n` + log.slice(-max);
            }
            const body = [
              "❌ **e2e** 失败",
              "",
              "<details>",
              "<summary>日志</summary>",
              "",
              "```text",
              log,
              "```",
              "</details>",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail if e2e failed
        if: steps.e2e.outputs.exit_code != '0'
        run: exit 1

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"
          cache-on: "lockfile"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        id: build
        continue-on-error: true
        shell: bash
        run: |
          set -o pipefail
          bun run build 2>&1 | tee build.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Comment build failure
        if: github.event_name == 'pull_request' && steps.build.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = "build.log";
            let log = fs.existsSync(path) ? fs.readFileSync(path, "utf8") : "No log file found.";
            const max = 60000;
            if (log.length > max) {
              log = `... (truncated, last ${max} chars)\n` + log.slice(-max);
            }
            const body = [
              "❌ **build** 失败",
              "",
              "<details>",
              "<summary>日志</summary>",
              "",
              "```text",
              log,
              "```",
              "</details>",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail if build failed
        if: steps.build.outputs.exit_code != '0'
        run: exit 1
